{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container">
  <div class="px-5 my-5 text-center">
    <h1>Device Results</h1>
    <p></p>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>IP</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="devices-list">
      {% for device in devices %}
      <tr id="device-{{ device.id }}" class="device-row">
        <td>{{ device.id }}</td>
        <td>{{ device.name }}</td>
        <td>{{ device.ip }}</td>
        <td>

          <div class="form-row">
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="start-date-{{ device.id }}">Start date</label>
                <input placeholder="Select date" type="date" id="start-date-mystrom-{{ device.id }}" class="form-control">
              </div>

              <div class="form-group col-md-4">
                <label for="end-date-{{ device.id }}">End date</label>
                <input placeholder="Select date" type="date" id="end-date-mystrom-{{ device.id }}" class="form-control">
              </div>
              <div class="form-group col-md-2">
                <button class="btn btn-danger" id="reset-dates-mystrom-{{ device.id }}" onclick="resetDates(this)">
                  Reset
                </button>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-9">
                <button class="btn btn-info" id="mystrom-{{ device.id }}" onclick="toggleChart(this.id), 'mystrom'">
                  Show Chart for Device {{ device.id }}
                </button>
              </div>
            </div>
          </div>


        </td>
      </tr>
      {% endfor %}
      {% for device in shelly_devices %}
      <tr id="device-{{ device.id }}" class="device-row">
        <td>{{ device.id }}</td>
        <td>{{ device.name }}</td>
        <td>{{ device.ip }}</td>
        <td>

          <div class="form-row">
            <div class="form-row">
              <div class="form-group col-md-4">
                <label for="start-date-{{ device.id }}">Start date</label>
                <input placeholder="Select date" type="date" id="start-date-shelly-{{ device.id }}" class="form-control">
              </div>

              <div class="form-group col-md-4">
                <label for="end-date-{{ device.id }}">End date</label>
                <input placeholder="Select date" type="date" id="end-date-shelly-{{ device.id }}" class="form-control">
              </div>
              <div class="form-group col-md-2">
                <button class="btn btn-danger" id="reset-dates-shelly-{{ device.id }}" onclick="resetDates(this)">
                  Reset
                </button>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group col-md-9">
                <button class="btn btn-info" id="shelly-{{ device.id }}" onclick="toggleChart(this.id, 'shelly')">
                  Show Chart for Device {{ device.id }}
                </button>
              </div>
            </div>
          </div>


        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <div id="chartContainer">

  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/apexcharts/3.35.3/apexcharts.min.js"></script>

{% include "mystrom_chart.html" %}
{% include "shelly_chart.html" %}

<script type="application/javascript">
  let shown = [];

  function resetDates(el) {
    const id = String(el.id).split("-")[2];
    document.getElementById("start-date-" + id).value = "";
    document.getElementById("end-date-" + id).value = "";
  }

  function toggleChart(id, device_type) {
    const startDateElement = document.getElementById("start-date-" + id);
    const endDateElement = document.getElementById("end-date-" + id);
    const elementId = "chart-" + id;
    if (shown.includes(id)) {
      document.getElementById(elementId).outerHTML = "";

      document.getElementById(id).innerHTML = "Show Chart for Device " + id;
      shown = shown.filter(shownId => shownId != id);
    } else {
      const createdElement = document.createElement("div");
      createdElement.setAttribute("id", elementId);
      document.getElementById("chartContainer").appendChild(createdElement);

      const informationElement = document.createElement("div");
      informationElement.setAttribute("id", elementId + "-information");
      createdElement.appendChild(informationElement);

      const chartElement = document.createElement("div");
      chartElement.setAttribute("id", elementId + "-chart");
      createdElement.appendChild(chartElement);

      if (device_type == "shelly") {
        loadShellyChart(id, elementId, startDateElement.value, endDateElement.value);
      } else {
        loadMystromChart(id, elementId, startDateElement.value, endDateElement.value);
      }

      document.getElementById(id).innerHTML = "Hide Chart for Device " + id;
      shown.push(id);
    }

  }

</script>
{% endblock %}