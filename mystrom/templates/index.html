{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <title>MyStrom Devices</title>
  </head>

  <body>
    <div class="container">
      <div class="px-5 my-5 text-center">
        <h1>MyStrom Devices</h1>
        <p></p>
      </div>
      
      <table class="table">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>IP</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="devices-list">
          {% include "device_table_entries.html" with devices=devices %}
        </tbody>
      </table>
      
      <!-- Button trigger modal -->
      <button hx-get="{% url 'devices' %}" hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}' hx-target="#dialog" class="btn btn-primary">
        Add Device
      </button>

      <button type="button" class="btn btn-danger" hx-delete="{% url 'devices' %}" hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}' hx-target="#devices-list">
        Delete Devices
      </button>
    </div>

    <!-- Placeholder for the modal -->
    <!-- Modal -->
    <div id="createModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
      <div id="dialog" class="modal-dialog" role="document">
            
      </div>
    </div>

  <script src="https://unpkg.com/htmx.org@1.6.1/dist/htmx.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/css/toastr.css" rel="stylesheet"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/js/toastr.js"></script>
  
  <script type="application/javascript">
  
  ;(function () {

    htmx.on("htmx:afterSwap", (e) => {
      if (e.detail.target.id == "dialog") {
        $("#createModal").modal('show');
      } else if (e.detail.requestConfig.path == "{% url 'devices' %}") {
        if (e.detail.requestConfig.verb == "post") {
          let deviceName = e.detail.requestConfig.parameters.name
          $("#createModal").modal('hide');
          toastr.success('Device ' + deviceName + ' created')
        } else if (e.detail.requestConfig.verb == "delete") {
          toastr.error('All devices deleted')
        }
      } else if (e.detail.requestConfig.path.startsWith("{% url 'devices' %}")) {
        let deviceName = e.detail.requestConfig.parameters.name
        $("#createModal").modal('hide');
        if (e.detail.requestConfig.verb == "post") {
          toastr.success('Device ' + deviceName + ' updated')
        } else if (e.detail.requestConfig.verb == "delete") {
          toastr.error('Device ' + deviceName + ' deleted')
        }
      }
    })

    htmx.on("htmx:beforeSwap", (e) => {
      if (e.detail.requestConfig.path == "{% url 'devices' %}" || e.detail.requestConfig.path.startsWith("{% url 'devices' %}")) {
        if (e.detail.requestConfig.verb == "post") {
          // when it contains invalid feedback, we do no want to swap and show error in form
          if (e.detail.xhr.response.includes("invalid-feedback")) {
            e.detail.shouldSwap = false
            let response = e.detail.xhr.response
            document.getElementById("modal-body").innerHTML = response

            // reset save buton from "Saving..." to "Save"
            submit_button = document.getElementById("modal-submit")
            submit_button.innerHTML = "Save"
            submit_button.disabled = false
          }
          
        } 
      }
    })

    // Remove dialog content after hiding
    htmx.on("hidden.bs.createModal", () => {
      console.log("HIDDEN")
      document.getElementById("dialog").innerHTML = ""
    })
  })()
  </script>

  </body>
</html>
